<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Admin Portal UI</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicons/favicon-c-modules.svg?v=20260220-1745" />
  <link rel="stylesheet" href="src/styles/tokens.css?v=20260220-1745" />
  <link rel="stylesheet" href="src/styles/base.css?v=20260220-1745" />
  <link rel="stylesheet" href="src/styles/layout.css?v=20260220-1745" />
  <link rel="stylesheet" href="src/styles/components.css?v=20260220-1745" />
</head>

<body>
  <header class="top-bar">
    <div class="brand">BW-Shell</div>
    <div class="user-menu">
      <button class="user-menu-button" id="userMenuButton" aria-expanded="false" aria-haspopup="true">jdoe_admin
        ▾</button>
      <div class="dropdown" id="userDropdown" role="menu" aria-label="User menu" hidden>
        <button type="button" role="menuitem">My Profile</button>
        <button type="button" role="menuitem">Preferences</button>
        <button type="button" role="menuitem">Sign Out</button>
      </div>
    </div>
  </header>

  <nav class="main-nav" aria-label="Primary">
    <button class="nav-item active" data-page="Accounts">Accounts</button>
    <button class="nav-item" data-page="Users">Users</button>
    <button class="nav-item" data-page="Compliance">Compliance</button>
    <button class="nav-item" data-page="Content">Content</button>
    <button class="nav-item" data-page="Websites">Websites</button>
    <button class="nav-item" data-page="Locator">Locator</button>
    <button class="nav-item" data-page="Video">Video</button>
    <button class="nav-item" data-page="Admin Tools">Admin Tools</button>
  </nav>

  <main>
    <section id="pageContainer" class="page-shell"></section>
  </main>

  <script src="src/data/mock/portal-data.js?v=20260220-1745"></script>
  <script src="src/data/mock/roles-permissions.js?v=20260220-1745"></script>
  <script src="src/state/store.js?v=20260220-1745"></script>
  <script src="src/views/accounts/accounts.view.js?v=20260220-1745"></script>
  <script src="src/views/users/users.view.js?v=20260220-1745"></script>
  <script src="src/views/content/content.view.js?v=20260220-1745"></script>
  <script src="src/views/placeholders/placeholders.view.js?v=20260220-1745"></script>

  <script>
    const navItems = document.querySelectorAll('.nav-item');
    const pageContainer = document.getElementById('pageContainer');
    const userMenuButton = document.getElementById('userMenuButton');
    const userDropdown = document.getElementById('userDropdown');
    const uiVersion = 'compliance-v2';
    const store = window.bwShellStore;
    const archivePdfSamples = ['assets/pdfs/ArchiveSnapsnot2.pdf', 'assets/pdfs/archivingExample.pdf'];

    document.body.setAttribute('data-ui-version', uiVersion);

    // Data/constants extracted to src/data/mock/portal-data.js (PR3).

    function setUserMenuOpen(isOpen) {
      store.set({ userMenuOpen: isOpen });
      userDropdown.classList.toggle('open', isOpen);
      userDropdown.hidden = !isOpen;
      userMenuButton.setAttribute('aria-expanded', String(isOpen));
    }

    function closeAllRowMenus() {
      document.querySelectorAll('.row-action-menu.open').forEach((menu) => menu.classList.remove('open'));
    }

    function attachRowMenuEvents() {
      const rowButtons = document.querySelectorAll('.row-action-button');

      rowButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          const targetMenu = button.nextElementSibling;
          const isOpen = targetMenu.classList.contains('open');
          closeAllRowMenus();
          if (!isOpen) {
            targetMenu.classList.add('open');
          }
        });
      });
    }
    function setPdfModalOpen(isOpen, pdfUrl = archivePdfSamples[0], title = 'Compliance Archive PDF') {
      const modal = document.getElementById('archivePdfModal');
      if (!modal) return;
      const frame = document.getElementById('archivePdfFrame');
      const titleEl = document.getElementById('archivePdfTitle');
      const openLink = document.getElementById('archivePdfOpenTab');
      if (isOpen) {
        if (titleEl) titleEl.textContent = title;
        if (frame) frame.src = pdfUrl;
        if (openLink) openLink.href = pdfUrl;
        modal.hidden = false;
      } else {
        modal.hidden = true;
        if (frame) frame.src = '';
      }
    }

    function attachPdfViewerEvents() {
      document.querySelectorAll('.pdf-view-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const pdfUrl = btn.dataset.pdfUrl || archivePdfSamples[0];
          setPdfModalOpen(true, pdfUrl, 'Compliance Archive PDF');
        });
      });

      document.getElementById('archivePdfCloseBtn')?.addEventListener('click', () => setPdfModalOpen(false));
      document.getElementById('archivePdfBackdrop')?.addEventListener('click', () => setPdfModalOpen(false));

      if (!document.body.dataset.archivePdfEscBound) {
        document.body.dataset.archivePdfEscBound = 'true';
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
            setPdfModalOpen(false);
          }
        });
      }
    }

    function renderArchiveTableRows(filteredRows) {
      return filteredRows
        .map((row, idx) => {
          const statusClass = row.status.toLowerCase();
          const revisionUrlCell = row.revision_url
            ? `<a href="${row.revision_url}" class="archive-link" target="_blank" rel="noopener noreferrer">Revision Link</a>`
            : '—';
          const diffCell = row.diff_json ? '<button type="button" class="json-payload-btn">Open JSON</button>' : '—';

          return `
              <tr>
                <td>${row.event_date}</td>
                <td class="archive-website-id">${row.website_id}</td>
                <td>${row.submitter_id}</td>
                <td>${row.approver_id}</td>
                <td><span class="archive-status ${statusClass}">${row.status}</span></td>
                <td>${row.bas_account_id}</td>
                <td>${row.wix_account_id}</td>
                <td>${row.site_id}</td>
                <td>${row.revision}</td>
                <td>${row.file_type === 'PDF' && row.status === 'Approved' ? `<button type="button" class="pdf-view-btn" data-pdf-url="${archivePdfSamples[idx % archivePdfSamples.length]}">View PDF</button>` : '--'}</td>
                <td>${revisionUrlCell}</td>
                <td>${diffCell}</td>
              </tr>
            `;
        })
        .join('');
    }

    function applyArchiveFilters() {
      const queryInput = document.getElementById('archiveSearchInput');
      const statusFilter = document.getElementById('archiveStatusFilter');
      const tableBody = document.getElementById('archiveTableBody');
      const resultsSummary = document.getElementById('archiveResultsSummary');

      const query = queryInput.value.trim().toLowerCase();
      const selectedStatus = statusFilter.value;

      const filteredRows = complianceArchiveRows
        .filter((row) => {
        const matchesQuery =
          !query ||
          row.submitter_id.toLowerCase().includes(query) ||
          row.approver_id.toLowerCase().includes(query) ||
          row.website_id.toLowerCase().includes(query) ||
          row.bas_account_id.toLowerCase().includes(query) ||
          row.wix_account_id.toLowerCase().includes(query) ||
          row.site_id.toLowerCase().includes(query);

          const matchesStatus = !selectedStatus || row.status === selectedStatus;

        })
        .sort((a, b) => new Date(b.event_date) - new Date(a.event_date));

      tableBody.innerHTML = filteredRows.length
        ? renderArchiveTableRows(filteredRows)
        : '<tr><td colspan="12">No archive records match your filters.</td></tr>';

      resultsSummary.textContent = `Showing ${filteredRows.length} of ${complianceArchiveRows.length} compliance archive records`;
    }

    function attachArchiveFilterEvents() {
      const queryInput = document.getElementById('archiveSearchInput');
      const statusFilter = document.getElementById('archiveStatusFilter');

      [queryInput, statusFilter].forEach((element) => {
        element.addEventListener('input', applyArchiveFilters);
        element.addEventListener('change', applyArchiveFilters);
      });
    }

    function renderArchiveView() {
      const compliancePanel = document.getElementById('compliancePanel');
      compliancePanel.innerHTML = `
          <div class="page-header">
            <h2 class="page-title">Compliance Archive</h2>
            <p class="page-subtitle">Search submitted, approved, and rejected compliance review events ordered newest to oldest.</p>
          </div>

          <div class="archive-toolbar" aria-label="Archive search and filters">
            <div class="field-group">
              <label for="archiveSearchInput">Search archive records</label>
              <input id="archiveSearchInput" class="text-input" type="search" placeholder="Search submitter email, approver, website, or account IDs" />
            </div>
            <div class="field-group">
              <label for="archiveStatusFilter">Status</label>
              <select id="archiveStatusFilter" class="text-input">
                <option value="">All statuses</option>
                <option value="Submitted">Submitted</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
              </select>
            </div>
          </div>

          <p class="archive-summary" id="archiveResultsSummary"></p>

          <div class="table-wrap archive-table-wrap">
            <table class="archive-table">
              <thead>
                <tr>
                  <th>Event Date</th>
                  <th>Website ID (Name)</th>
                  <th>Submitter ID</th>
                  <th>Approver ID</th>
                  <th>Status</th>
                  <th>BAS Account ID</th>
                  <th>Wix Account ID</th>
                  <th>Site MSID</th>
                  <th>Revision</th>
                  <th>File Type</th>
                  <th>Revision URL</th>
                  <th>JSON Diff Data</th>
                </tr>
              </thead>
              <tbody id="archiveTableBody"></tbody>
            </table>
          </div>

          <div class="pdf-modal" id="archivePdfModal" hidden>
            <div class="pdf-modal-backdrop" id="archivePdfBackdrop"></div>
            <div class="pdf-modal-dialog" role="dialog" aria-modal="true" aria-label="PDF Viewer">
              <div class="pdf-modal-header">
                <h3 id="archivePdfTitle">Compliance Archive PDF</h3>
                <div class="pdf-modal-actions">
                  <a id="archivePdfOpenTab" class="page-btn" href="#" target="_blank" rel="noopener noreferrer">Open in New Tab</a>
                  <button id="archivePdfCloseBtn" type="button" class="page-btn">Close</button>
                </div>
              </div>
              <div class="pdf-modal-body">
                <iframe id="archivePdfFrame" title="Compliance PDF Viewer" loading="lazy"></iframe>
              </div>
            </div>
          </div>
        `;

      attachArchiveFilterEvents();
      applyArchiveFilters();
      attachPdfViewerEvents();
    }

    function renderCompliancePanel(tabName) {
      if (tabName === 'Archive') {
        renderArchiveView();
        return;
      }

      const selectedTab = complianceTabs.find((tab) => tab.name === tabName) || complianceTabs[0];
      const compliancePanel = document.getElementById('compliancePanel');
      compliancePanel.innerHTML = `
          <h3>${selectedTab.name}</h3>
          <p>${selectedTab.description}</p>
        `;
    }

    function attachComplianceTabEvents() {
      const complianceSubnavItems = document.querySelectorAll('.compliance-subnav-item');

      complianceSubnavItems.forEach((item) => {
        item.addEventListener('click', () => {
          const selectedTabName = item.dataset.complianceTab;
          complianceSubnavItems.forEach((button) => {
            button.classList.toggle('active', button === item);
            button.setAttribute('aria-selected', String(button === item));
          });
          renderCompliancePanel(selectedTabName);
        });
      });
    }

    function renderComplianceView() {
      const subnavButtons = complianceTabs
        .map(
          (tab, index) => `
              <button
                class="compliance-subnav-item${tab.name === defaultComplianceTab ? ' active' : ''}"
                type="button"
                data-compliance-tab="${tab.name}"
                role="tab"
                aria-selected="${tab.name === defaultComplianceTab ? 'true' : 'false'}"
              >
                ${tab.name}
              </button>
            `
        )
        .join('');

      pageContainer.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Compliance</h1>
          </div>
          <div class="compliance-subnav" aria-label="Compliance sub navigation" role="tablist">
            ${subnavButtons}
          </div>
          <section class="compliance-panel" id="compliancePanel"></section>
        `;

      renderCompliancePanel(defaultComplianceTab);
      attachComplianceTabEvents();
    }

    function getAdminToolsRowId(tabConfig, row, index) {
      if (row.roleKey) {
        return row.roleKey;
      }

      if (row.userId) {
        return row.userId;
      }

      if (row.accountId) {
        return row.accountId;
      }

      if (row.name) {
        return row.name;
      }

      return `${tabConfig.name}-${index}`;
    }

    function getAdminToolsTableClass(tabName) {
      const key = String(tabName || '').toLowerCase().replace(/[^a-z0-9]+/g, '-');
      return `admin-tools-table tab-${key}`;
    }

    function renderAdminToolsTableRows(tabConfig, rows) {
      const showCrud = tabConfig.enableCrud !== false;
      const hideCreateReadActions = tabConfig.name === 'BAS Roles' || tabConfig.name === 'BAS Users' || tabConfig.name === 'BAS Accounts';
      const showCreateReadActions = showCrud && !hideCreateReadActions;
      return rows
        .map((row, rowIndex) => {
          const rowId = getAdminToolsRowId(tabConfig, row, rowIndex);
          const editableRows = adminToolsEditRows[tabConfig.name] || new Set();
          const isEditing = editableRows.has(rowId);
          const valueCells = tabConfig.columns
            .map((column) => {
              const value = row[column.key];
              const tdClasses = [typeof value === 'number' ? 'numeric-col' : '', column.key === 'description' && tabConfig.name === 'BAS Roles' ? 'role-description-col' : ''].filter(Boolean).join(' ');
              const widthStyle = column.width ? ` style="width:${column.width};max-width:${column.width};"` : '';

              if (column.key === 'viewUrl' && value) {
                return `<td class="${tdClasses}"${widthStyle}><a href="${value}" class="archive-link" target="_blank" rel="noopener noreferrer">${value}</a></td>`;
              }

              if (!isEditing && column.key === 'state' && tabConfig.name === 'BAS Users') {
                const stateClass = String(value).toLowerCase() === 'active' ? 'active' : '';
                return `<td class="${tdClasses}" data-column-key="${column.key}"${widthStyle}><span class="status-pill ${stateClass}">${value}</span></td>`;
              }

              if (column.key === 'staffFlag' && tabConfig.name === 'BAS Roles') {
                return `<td class="${tdClasses} bas-staff-col" data-column-key="${column.key}"${widthStyle}>${value ? '<span class="staff-flag">Staff Role</span>' : '--'}</td>`;
              }

              if (isEditing) {
                return `<td class="${tdClasses}" contenteditable="true" data-column-key="${column.key}"${widthStyle}>${value}</td>`;
              }

              return `<td class="${tdClasses}" data-column-key="${column.key}"${widthStyle}>${value}</td>`;
            })
            .join('');

          return `
              <tr data-row-id="${rowId}">
                ${valueCells}
                ${showCrud
                  ? `
                ${showCreateReadActions ? '<td class="crud-cell"><button class="crud-action-btn" type="button">Create</button></td>' : ''}
                ${showCreateReadActions ? '<td class="crud-cell"><button class="crud-action-btn" type="button">Read</button></td>' : ''}
                ${tabConfig.name !== 'BAS Users' && tabConfig.name !== 'BAS Accounts' && tabConfig.name !== 'BAS Roles' ? `<td class="crud-cell"><button class="crud-action-btn update-btn${isEditing ? ' editing' : ''}" type="button">Update</button></td>` : ''}
                
                <td class="crud-cell">${tabConfig.name === 'BAS Roles' && String(row.roleName).toLowerCase() === 'super admin' ? '<span class="crud-disabled">System</span>' : '<button class="crud-action-btn" type="button">Delete</button>'}</td>
                `
                  : ''}
              </tr>
            `;
        })
        .join('');
    }

    function deriveRoleDescriptionFromPermissions(permissions) {
      const perms = permissions || [];
      const has = (token) => perms.some((p) => String(p).toLowerCase().includes(token));

      const canManageUsers = has('create a new user') || has('update user details') || has('disable a user');
      const canManageAccounts = has('create a new account') || has('update an account') || has('delete an account');
      const canManageCompliance = has('compliance') || has('workflow');
      const canManageBilling = has('billing') || has('subscription');
      const canManageRoles = has('create roles') || has('edit roles') || has('delete roles');

      if (canManageAccounts && canManageUsers && canManageCompliance && canManageRoles) {
        return 'Full-spectrum operational role with account administration, user controls, compliance workflow management, and role governance.';
      }
      if (canManageAccounts && canManageUsers && canManageRoles) {
        return 'Operations-focused role for managing accounts, user lifecycle actions, and role assignments across the platform.';
      }
      if (canManageCompliance) {
        return 'Compliance-focused role for monitoring review queues, workflows, and policy-driven approval operations.';
      }
      if (canManageUsers) {
        return 'User management role for onboarding, maintaining, and supporting users with controlled access operations.';
      }
      if (canManageBilling) {
        return 'Commercial operations role for handling billing visibility and subscription-related account updates.';
      }
      return 'Business support role with scoped permissions for daily platform operations.';
    }

    function getBasRolesRowsFromRoleDataset(fallbackRows) {
      const roleData = window.rolePermissionData;
      if (!roleData || !Array.isArray(roleData.rolePresets)) {
        return fallbackRows;
      }

      const usersByRole = {
        'Super Admin': 5,
        'Broadridge Manager': 8,
        'Service': 15,
        'Sales': 12,
        'Financial Advisor': 22,
        'Program Admin': 12,
        'Complaince Admin': 6,
        'Compliance Reviewer': 15
      };

      const staffRoles = new Set(['Super Admin', 'Broadridge Manager', 'Service', 'Sales']);

      return roleData.rolePresets.map((role) => ({
        roleName: role.title || role.name,
        roleKey: String(role.name || role.title || '').toUpperCase().replace(/[^A-Z0-9]+/g, '_'),
        description: deriveRoleDescriptionFromPermissions(role.permissions || []),
        usersAssigned: usersByRole[role.title || role.name] ?? Math.max(1, Math.min(99, (role.permissions || []).length)),
        permissionCount: (role.permissions || []).length,
        staffFlag: staffRoles.has(role.title || role.name),
        assignmentBand: ((usersByRole[role.title || role.name] ?? 0) <= 10) ? '0-10' : ((usersByRole[role.title || role.name] ?? 0) <= 25 ? '11-25' : '26+'),
        updatedOn: '2026-02-20',
        permissions: role.permissions || []
      }));
    }

    function applyAdminToolsFilters() {
      const panel = document.getElementById('adminToolsPanel');
      if (!panel) {
        return;
      }

      const selectedTabName = panel.dataset.activeAdminToolsTab;
      const tabConfig = adminToolsTabs.find((tab) => tab.name === selectedTabName) || adminToolsTabs[0];
      const showCrud = tabConfig.enableCrud !== false;
      const hideCreateReadActions = tabConfig.name === 'BAS Roles' || tabConfig.name === 'BAS Users' || tabConfig.name === 'BAS Accounts';
      const showCreateReadActions = showCrud && !hideCreateReadActions;
      const actionColumnCount = !showCrud ? 0 : tabConfig.name === 'BAS Users' ? 1 : tabConfig.name === 'BAS Accounts' ? 1 : tabConfig.name === 'BAS Roles' ? 1 : showCreateReadActions ? 4 : 2;
      const searchInput = document.getElementById('adminToolsSearchInput');
      const tableBody = document.getElementById('adminToolsTableBody');
      const resultsSummary = document.getElementById('adminToolsResultsSummary');

      if (!searchInput || !tableBody || !resultsSummary) {
        return;
      }

      const query = searchInput.value.trim().toLowerCase();
      const filterSelections = tabConfig.filters.reduce((accumulator, filter) => {
        const filterElement = document.getElementById(`adminToolsFilter-${filter.id}`);
        accumulator[filter.id] = filterElement ? filterElement.value : '';
        return accumulator;
      }, {});

      const sourceRows = tabConfig.name === 'BAS Roles'
        ? getBasRolesRowsFromRoleDataset(tabConfig.rows)
        : tabConfig.rows;

      const filteredRows = sourceRows.filter((row) => {
        const matchesQuery =
          !query ||
          tabConfig.searchFields.some((fieldName) => String(row[fieldName] ?? '').toLowerCase().includes(query));

        const matchesAllFilters = tabConfig.filters.every((filter) => {
          const selectedValue = filterSelections[filter.id];
          return !selectedValue || String(row[filter.id]) === selectedValue;
        });

        return matchesQuery && matchesAllFilters;
      });

      tableBody.innerHTML = filteredRows.length
        ? renderAdminToolsTableRows(tabConfig, filteredRows)
        : `<tr><td colspan="${tabConfig.columns.length + actionColumnCount}">No ${tabConfig.name.toLowerCase()} records match your filters.</td></tr>`;

      if (showCrud) {
        attachAdminToolsCrudEvents(tabConfig);
      }

      resultsSummary.textContent = `Showing ${filteredRows.length} of ${sourceRows.length} ${tabConfig.name.toLowerCase()} records`;
    }

    function attachAdminToolsFilterEvents(tabConfig) {
      const searchInput = document.getElementById('adminToolsSearchInput');
      if (!searchInput) {
        return;
      }

      const elements = [
        searchInput,
        ...tabConfig.filters
          .map((filter) => document.getElementById(`adminToolsFilter-${filter.id}`))
          .filter(Boolean)
      ];

      elements.forEach((element) => {
        element.addEventListener('input', applyAdminToolsFilters);
        element.addEventListener('change', applyAdminToolsFilters);
      });
    }

    function attachAdminToolsCrudEvents(tabConfig) {
      const tableBody = document.getElementById('adminToolsTableBody');
      if (!tableBody) {
        return;
      }

      tableBody.querySelectorAll('.update-btn').forEach((button) => {
        button.addEventListener('click', () => {
          const rowElement = button.closest('tr');
          if (!rowElement) {
            return;
          }

          const rowId = rowElement.dataset.rowId;
          const editableRows = adminToolsEditRows[tabConfig.name] || new Set();
          const isEditing = editableRows.has(rowId);
          const matchingRow = tabConfig.rows.find((row, rowIndex) => getAdminToolsRowId(tabConfig, row, rowIndex) === rowId);

          if (!matchingRow) {
            return;
          }

          if (!isEditing) {
            editableRows.add(rowId);
            adminToolsEditRows[tabConfig.name] = editableRows;
            applyAdminToolsFilters();
            return;
          }

          rowElement.querySelectorAll('td[data-column-key]').forEach((cell) => {
            const key = cell.dataset.columnKey;
            matchingRow[key] = cell.textContent.trim();
          });

          editableRows.delete(rowId);
          adminToolsEditRows[tabConfig.name] = editableRows;
          applyAdminToolsFilters();
        });
      });
    }

    function renderCalculatorsPanel(selectedTab) {
      const panel = document.getElementById('adminToolsPanel');
      const tableRows = selectedTab.rows
        .map(
          (row, index) => `
              <tr>
                <td class="calc-checkbox-cell"><input type="checkbox" aria-label="Select calculator row ${index + 1}" ${row.checked ? 'checked' : ''} /></td>
                <td>${row.status}</td>
                <td>${row.description}</td>
                <td>${row.expiryDate}</td>
                <td>${row.publishDate}</td>
              </tr>
            `
        )
        .join('');

      panel.dataset.activeAdminToolsTab = selectedTab.name;
      panel.innerHTML = `
          <h3>${selectedTab.name}</h3>
          <p>${selectedTab.description}</p>
          <div class="calculators-table-wrap">
            <table class="calculators-table">
              <thead>
                <tr>
                  <th scope="col"></th>
                  <th scope="col">Calcualtor Status</th>
                  <th scope="col">Description</th>
                  <th scope="col">Expiry Date</th>
                  <th scope="col">Publish Date</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
    }

    function renderWixRolesPanel(selectedTab) {
      const panel = document.getElementById('adminToolsPanel');
      const renderRows = (rows) =>
        rows
          .map(
            (row) => `
                <tr>
                  <td>${row.roleName}</td>
                  <td>${row.description}</td>
                  <td>${row.permissions}</td>
                </tr>
              `
          )
          .join('');

      panel.dataset.activeAdminToolsTab = selectedTab.name;
      panel.innerHTML = `
          <h3>${selectedTab.name}</h3>
          <p>${selectedTab.description}</p>

          <h4 class="admin-tools-subtable-title">Pre defined roles</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th scope="col">Role name</th>
                  <th scope="col">Description</th>
                  <th scope="col">Permissions</th>
                </tr>
              </thead>
              <tbody>
                ${renderRows(selectedTab.preDefinedRoles)}
              </tbody>
            </table>
          </div>

          <h4 class="admin-tools-subtable-title">Custom Roles</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th scope="col">Role name</th>
                  <th scope="col">Description</th>
                  <th scope="col">Permissions</th>
                </tr>
              </thead>
              <tbody>
                ${renderRows(selectedTab.customRoles)}
              </tbody>
            </table>
          </div>
        `;
    }

    function renderAdminToolsPanel(tabName) {
      const selectedTab = adminToolsTabs.find((tab) => tab.name === tabName) || adminToolsTabs[0];

      if (selectedTab.name === 'Wix Roles') {
        renderWixRolesPanel(selectedTab);
        return;
      }

      if (selectedTab.name === 'Calculators') {
        renderCalculatorsPanel(selectedTab);
        return;
      }

      const panel = document.getElementById('adminToolsPanel');
      const filterFields = selectedTab.filters
        .map(
          (filter) => `
              <div class="field-group">
                <label for="adminToolsFilter-${filter.id}">${filter.label}</label>
                <select id="adminToolsFilter-${filter.id}" class="text-input">
                  <option value="">${filter.allLabel}</option>
                  ${filter.options.map((option) => `<option value="${option}">${option}</option>`).join('')}
                </select>
              </div>
            `
        )
        .join('');

      const headerCells = selectedTab.columns
        .map((column) => `<th scope="col">${column.label}</th>`)
        .join('');
      const showCrud = selectedTab.enableCrud !== false;
      const hideCreateReadActions = selectedTab.name === 'BAS Roles' || selectedTab.name === 'BAS Users' || selectedTab.name === 'BAS Accounts';
      const showCreateReadActions = showCrud && !hideCreateReadActions;

      panel.dataset.activeAdminToolsTab = selectedTab.name;
      panel.innerHTML = `
          <h3>${selectedTab.name}</h3>
          <p>${selectedTab.description}</p>
          <div class="admin-tools-toolbar" aria-label="${selectedTab.name} search and filters" ${selectedTab.name === 'BAS Roles' ? 'style="display:none"' : ''}>
            <div class="field-group">
              <label for="adminToolsSearchInput">Search</label>
              <input id="adminToolsSearchInput" class="text-input" type="search" placeholder="${selectedTab.searchPlaceholder}" />
            </div>
            ${filterFields}
          </div>
          <p class="admin-tools-summary" id="adminToolsResultsSummary"></p>
          <div class="table-wrap">
            <table class="${getAdminToolsTableClass(selectedTab.name)}">
              <thead>
                <tr>
                  ${headerCells}
                  ${showCrud
                    ? `
                  ${showCreateReadActions ? '<th scope="col" class="action-col">Create</th>' : ''}
                  ${showCreateReadActions ? '<th scope="col" class="action-col">Read</th>' : ''}
                  ${selectedTab.name !== 'BAS Users' && selectedTab.name !== 'BAS Accounts' && selectedTab.name !== 'BAS Roles' ? '<th scope="col" class="action-col">Update</th>' : ''}
                  
                  <th scope="col" class="action-col">Delete</th>
                  `
                    : ''}
                </tr>
              </thead>
              <tbody id="adminToolsTableBody"></tbody>
            </table>
          </div>
        `;

      attachAdminToolsFilterEvents(selectedTab);
      applyAdminToolsFilters();
    }

    function attachAdminToolsTabEvents() {
      const items = document.querySelectorAll('.admin-tools-subnav-item');
      items.forEach((item) => {
        item.addEventListener('click', () => {
          const selectedTabName = item.dataset.adminToolsTab;
          items.forEach((button) => {
            button.classList.toggle('active', button === item);
            button.setAttribute('aria-selected', String(button === item));
          });
          renderAdminToolsPanel(selectedTabName);
        });
      });
    }

    function renderAdminToolsView() {
      const subnavButtons = adminToolsTabs
        .map(
          (tab) => `
              <button
                class="admin-tools-subnav-item${tab.name === defaultAdminToolsTab ? ' active' : ''}"
                type="button"
                data-admin-tools-tab="${tab.name}"
                role="tab"
                aria-selected="${tab.name === defaultAdminToolsTab ? 'true' : 'false'}"
              >
                ${tab.name}
              </button>
            `
        )
        .join('');

      pageContainer.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">Admin Tools</h1>
          </div>
          <div class="admin-tools-subnav" aria-label="Admin tools sub navigation" role="tablist">
            ${subnavButtons}
          </div>
          <section class="admin-tools-panel" id="adminToolsPanel"></section>
        `;

      renderAdminToolsPanel(defaultAdminToolsTab);
      attachAdminToolsTabEvents();
    }

    function renderSection(sectionName) {
      store.set({ activePage: sectionName });
      closeAllRowMenus();
      if (sectionName === 'Accounts') {
        renderAccountsView();
        return;
      }
      if (sectionName === 'Users') {
        renderUsersView();
        return;
      }
      if (sectionName === 'Compliance') {
        renderComplianceView();
        return;
      }
      if (sectionName === 'Content') {
        renderContentView();
        return;
      }
      if (sectionName === 'Admin Tools') {
        renderAdminToolsView();
        return;
      }
      renderPlaceholderView(sectionName);
    }

    navItems.forEach((button) => {
      button.addEventListener('click', () => {
        const selectedPage = button.dataset.page;
        navItems.forEach((item) => item.classList.toggle('active', item === button));
        renderSection(selectedPage);
      });
    });

    setUserMenuOpen(false);

    userMenuButton.addEventListener('click', () => {
      const isOpen = userMenuButton.getAttribute('aria-expanded') === 'true';
      setUserMenuOpen(!isOpen);
    });

    document.addEventListener('click', (event) => {
      if (!event.target.closest('.user-menu')) {
        setUserMenuOpen(false);
      }

      if (!event.target.closest('.actions-cell')) {
        closeAllRowMenus();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        setUserMenuOpen(false);
        closeAllRowMenus();
      }
    });

    const initialPage = store.state.activePage || 'Accounts';
    navItems.forEach((item) => item.classList.toggle('active', item.dataset.page === initialPage));
    renderSection(initialPage);
  </script>
</body>

</html>
